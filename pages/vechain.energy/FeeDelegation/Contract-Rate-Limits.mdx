# Contract-Rate-Limits

Every rate limit is defined by the maximum number of requests for a given duration. For example a limit of 10 and a duration of 30 will result in a maximum of 10 requests within 30 seconds.

Every signing request of a **consumer** counts against the limits within the defined duration. A consumer can be a user address sending a transaction or a group of users or even everyone.

**Groups** organize consumers. A group allows a consumer to have different limits on different contracts or functionality.

For each request your contract is called with each clause and the rate limit is enforced in the API. Transaction origin, recipient and the transaction data are sent to your contract to identify the rate limit definition.

```mermaid
sequenceDiagram
    participant User
    participant vechain.energy
    participant vechain.energy Contract
    participant DeveloperContract

    User->>vechain.energy: send delegation request
    vechain.energy->>vechain.energy Contract: call canSponsorTransactionFor(sender, recipient, txData, tokenId)
    vechain.energy Contract-->>vechain.energy Contract: lookup Sponsorship-Token
    alt is sender whitelisted?
       vechain.energy Contract-->>vechain.energy: true
    else is recipient whitelisted?
       vechain.energy Contract-->>vechain.energy: true
    else is contract configured?
       vechain.energy Contract->>DeveloperContract: call canSponsorTransactionFor(sender, recipient, txData)
       DeveloperContract-->>vechain.energy Contract: true | false
       vechain.energy Contract-->>vechain.energy: pass return value
    else else
       vechain.energy Contract-->>vechain.energy: false
    end

    alt sponsorship is not allowed
       vechain.energy-->>User: Error
    else sponsorship is allowed
      vechain.energy-->>vechain.energy Contract: rate limit enabled?
      vechain.energy Contract-->>vechain.energy: true | false
      opt rate limit is enabled
         vechain.energy->>DeveloperContract: call rateLimitSponsorFor(sender, recipient, txData)
         DeveloperContract-->>vechain.energy: rate limit definition
         opt consumer requested more than "limit" in the past "duration"?
            vechain.energy-->>User: Error
         end
      end

      vechain.energy->>vechain.energy: lookup Wallet
      vechain.energy->>vechain.energy: Co-Sign transaction with Wallet
      vechain.energy-->>User: Signature
    end
```

## Function-Definition

Add this function to your contract to support verification:

```solidity copy
function rateLimitSponsorFor(
    address _origin,
    address _to,
    bytes memory _data
)
    public
    view
    returns (
        uint32 limit,
        uint32 duration,
        bytes32 consumer,
        bytes32 group
    )
{}
```

### Example-Snippets

#### "Unlimited" calls for an owner

Calculates a consumer id based on the user address and if it is not the owner, the limit is set to 10 signing requests within 60 seconds

```solidity copy
function rateLimitSponsorFor(
    address _origin,
    address _to,
    bytes memory _data
)
    public
    view
    returns (
        uint32 limit,
        uint32 duration,
        bytes32 consumer
        bytes32 group
    )
{
  // a unique consumer id based is important to identify each user
  consumer = keccak256(abi.encodePacked(_origin));

  limit = 10;
  duration = 60;

  if (_origin == owner()) {
    limit = 1000;
    duration = 10;
  }
}
```

#### Limit all users to 100 calls per minute

Return the same consumer for all requests identifies all users as the same

```solidity copy
function rateLimitSponsorFor(
    address _origin,
    address _to,
    bytes memory _data
)
    public
    view
    returns (
        uint32 limit,
        uint32 duration,
        bytes32 consumer
        bytes32 group
    )
{
  limit = 100;
  duration = 60;
}
```